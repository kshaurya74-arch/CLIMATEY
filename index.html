<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEROVA | Climate Data Hackathon 2026</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&family=Open+Sans:wght@400;600&family=Audiowide&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        /* --- THEME COLORS --- */
        :root {
            --bg-dark: #050505;
            --card-bg: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --neon-green: #00ff9d;
            --neon-red: #ff0000; 
            --danger-red: #ff003c; 
            --neon-blue: #00d2ff;
            --neon-yellow: #f1c40f;
            --neon-orange: #ff9f43;
            --text-main: #ffffff;
            --text-muted: #888888;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.7)),
                url('https://media.istockphoto.com/id/167231386/photo/detail-of-white-smoke-polluted-sky.jpg?s=612x612&w=0&k=20&c=hExCnY1CN7xieBUcBTQ8h37TDLkSWCT06l8bbShbQvE=');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* --- 30% TOP BANNER --- */
        #top-banner {
            position: relative; 
            width: 100%;
            height: 30vh; 
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            border-bottom: 2px solid var(--neon-green);
            background: #000;
        }

        #top-banner video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            filter: brightness(0.4) saturate(1.2);
        }

        .banner-content {
            display: flex;
            align-items: center;
            gap: 25px;
            z-index: 1;
        }

        .banner-logo {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            object-position: center; 
            border: 3px solid var(--neon-green);
            box-shadow: 0 0 20px var(--neon-green);
            background-color: #000;
        }

        .banner-text {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .banner-title {
            font-family: 'Audiowide', cursive;
            font-size: 3.5rem;
            color: #fff;
            margin: 0;
            line-height: 1;
            letter-spacing: 5px;
            text-shadow: 0 0 15px var(--neon-blue), 0 0 30px var(--neon-blue);
        }

        .banner-quote {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            color: var(--neon-blue); 
            margin: 5px 0 0 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.9);
        }

        /* --- HORIZONTAL NAVIGATION WITH MULTICOLOR HOVER --- */
        nav {
            position: sticky;
            top: 20px; 
            margin: 30px auto;
            width: 95%;
            max-width: 950px;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(12px);
            padding: 12px 25px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            z-index: 9999;
            display: flex;
            flex-direction: row; 
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        nav a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.8rem;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            text-align: center;
        }

        nav a i { font-size: 1.1rem; }

        /* General scale effect on hover */
        nav a:hover, nav a.active {
            transform: scale(1.05); 
        }

        /* INDIVIDUAL NAV ITEM COLORS */
        #nav-home:hover, #nav-home.active { color: #ffffff; text-shadow: 0 0 12px rgba(255, 255, 255, 0.8); }
        #nav-navigation:hover, #nav-navigation.active { color: var(--neon-green); text-shadow: 0 0 12px rgba(0, 255, 157, 0.6); }
        #nav-maps:hover, #nav-maps.active { color: #d9853b; text-shadow: 0 0 12px rgba(217, 133, 59, 0.6); }
        #nav-rules:hover, #nav-rules.active { color: var(--danger-red); text-shadow: 0 0 12px rgba(255, 0, 60, 0.6); }
        #nav-ev:hover, #nav-ev.active { color: var(--neon-blue); text-shadow: 0 0 12px rgba(0, 210, 255, 0.6); }
        #nav-awareness:hover, #nav-awareness.active { color: var(--neon-yellow); text-shadow: 0 0 12px rgba(241, 196, 15, 0.6); }
        #nav-reports:hover, #nav-reports.active { color: var(--neon-orange); text-shadow: 0 0 12px rgba(255, 159, 67, 0.6); }

        /* --- GLOBAL CLICK / PRESS DOWN EFFECTS --- */
        button:active, 
        .action-btn:active, 
        .submit-btn:active, 
        nav a:active,
        .grap-item:active,
        .ev-list-item:active,
        .weather-metric-item:active,
        .quiz-option:active {
            transform: scale(0.92) !important;
            transition: transform 0.1s ease !important;
            opacity: 0.8;
        }

        /* --- SECTIONS --- */
        section {
            display: none;
            min-height: 70vh; 
            padding: 20px 20px 60px 20px; 
            flex-direction: column;
            align-items: center;
            max-width: 1300px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        section.active-section { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media(max-width: 768px) {
            .banner-title { font-size: 2rem; }
            .banner-quote { font-size: 0.8rem; }
            .banner-logo { width: 60px; height: 60px; }
            nav {
                position: fixed;
                bottom: 20px;
                top: auto;
                left: 50%;
                transform: translateX(-50%);
                margin: 0;
                width: 95%;
                padding: 10px 15px;
                overflow-x: auto;
            }
            nav::-webkit-scrollbar { display: none; }
            nav a { font-size: 0.65rem; min-width: 65px; }
            section { padding: 20px 20px 100px 20px; }
            
            #weather-metrics {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            .weather-divider { display: none; }
        }

        h1, h2, h3 { 
            font-family: 'Montserrat', sans-serif; 
            text-transform: uppercase; 
            letter-spacing: -0.5px;
        }
        
        h2 { 
            font-size: 2.5rem; 
            font-weight: 800;
            margin-bottom: 40px; 
            background: linear-gradient(90deg, #fff, var(--text-muted)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-align: center;
        }

        /* --- COMPONENTS --- */
        .glass-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, border-color 0.3s;
            width: 100%;
        }
        
        .glass-card h4 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem; 
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        .location-badge {
            background: rgba(0, 255, 157, 0.1);
            color: var(--neon-green);
            padding: 8px 20px;
            border-radius: 30px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            border: 1px solid rgba(0, 255, 157, 0.2);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; box-shadow: 0 0 15px rgba(0,255,157,0.2); } 100% { opacity: 0.8; } }

        /* --- ANIMATED AQI CIRCLE --- */
        .aqi-wrapper {
            position: relative; width: 320px; height: 320px;
            display: flex; justify-content: center; align-items: center; margin: 20px 0;
        }
        .aqi-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .aqi-circle-bg { fill: none; stroke: #222; stroke-width: 15; }
        .aqi-circle-progress {
            fill: none; stroke: var(--neon-green); stroke-width: 15;
            stroke-linecap: round; stroke-dasharray: 880; stroke-dashoffset: 880; 
            transition: stroke-dashoffset 2s ease-out, stroke 1s ease, filter 1s ease;
            filter: drop-shadow(0 0 15px var(--neon-green));
        }
        .aqi-inner-content {
            position: absolute; text-align: center; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .aqi-number { 
            font-family: 'Montserrat', sans-serif; font-size: 5rem; 
            font-weight: 800; color: #fff; line-height: 1; text-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .aqi-label { color: var(--text-muted); font-size: 0.9rem; letter-spacing: 2px; margin-top: 10px; font-weight: 600; }

        /* --- WEATHER METRICS HOVER ANIMATIONS --- */
        .weather-metric-item {
            flex: 1; text-align: center; padding: 15px 10px; border-radius: 16px;
            border: 1px solid transparent; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer;
        }
        .weather-metric-item i { display: inline-block; transition: all 0.3s ease; }
        
        .weather-metric-item.metric-temp:hover { background: rgba(255, 0, 0, 0.08); border-color: rgba(255, 0, 0, 0.4); box-shadow: 0 10px 25px rgba(255, 0, 0, 0.2), inset 0 0 15px rgba(255, 0, 0, 0.1); transform: translateY(-8px); }
        .weather-metric-item.metric-temp:hover i { animation: tempHeat 0.6s infinite alternate; filter: drop-shadow(0 0 15px var(--neon-red)); color: #ff3366 !important; }
        @keyframes tempHeat { 0% { transform: scale(1) translateY(0); } 100% { transform: scale(1.2) translateY(-4px); } }

        .weather-metric-item.metric-humidity:hover { background: rgba(0, 210, 255, 0.08); border-color: rgba(0, 210, 255, 0.4); box-shadow: 0 10px 25px rgba(0, 210, 255, 0.2), inset 0 0 15px rgba(0, 210, 255, 0.1); transform: translateY(-8px); }
        .weather-metric-item.metric-humidity:hover i { animation: humDrip 1.2s infinite; filter: drop-shadow(0 0 15px var(--neon-blue)); }
        @keyframes humDrip { 0% { transform: translateY(-3px) scale(1); opacity: 1; } 50% { transform: translateY(6px) scale(1.1); opacity: 0.8; } 100% { transform: translateY(12px) scale(0.6); opacity: 0; } }

        .weather-metric-item.metric-wind:hover { background: rgba(168, 255, 0, 0.08); border-color: rgba(168, 255, 0, 0.4); box-shadow: 0 10px 25px rgba(168, 255, 0, 0.2), inset 0 0 15px rgba(168, 255, 0, 0.1); transform: translateY(-8px); }
        .weather-metric-item.metric-wind:hover i { animation: windBlow 0.8s infinite linear; filter: drop-shadow(0 0 15px #a8ff00); }
        @keyframes windBlow { 0% { transform: translateX(0); } 25% { transform: translateX(6px) translateY(-2px) skewX(-15deg); } 50% { transform: translateX(0); } 75% { transform: translateX(-4px) translateY(2px) skewX(10deg); } 100% { transform: translateX(0); } }

        .weather-metric-item.metric-air:hover { background: rgba(0, 255, 157, 0.08); border-color: rgba(0, 255, 157, 0.4); box-shadow: 0 10px 25px rgba(0, 255, 157, 0.2), inset 0 0 15px rgba(0, 255, 157, 0.1); transform: translateY(-8px); }
        .weather-metric-item.metric-air:hover i { animation: leafSway 1.5s infinite ease-in-out; filter: drop-shadow(0 0 15px var(--neon-green)); }
        @keyframes leafSway { 0%, 100% { transform: rotate(0deg) scale(1); } 50% { transform: rotate(25deg) scale(1.15); } }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; width: 100%; margin-top: 20px; }
        #home .dashboard-grid { display: flex; flex-direction: column; align-items: center; }
        #home .dashboard-grid .glass-card { max-width: 600px; width: 100%; }

        .action-btn { background: transparent; border: 1px solid var(--text-muted); color: var(--text-main); padding: 10px 24px; border-radius: 30px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600; transition: 0.3s; }
        .action-btn:hover { border-color: var(--neon-blue); background: rgba(0, 210, 255, 0.1); color: var(--neon-blue); }

        /* --- SOS FLOATING BUTTON --- */
        .sos-fab {
            position: fixed; bottom: 120px; right: 30px; width: 70px; height: 70px; background: var(--danger-red); border-radius: 50%;
            display: flex; justify-content: center; align-items: center; box-shadow: 0 0 20px rgba(255, 0, 60, 0.5); z-index: 2000; cursor: pointer;
            animation: pulse-red 2s infinite; border: 3px solid white; transition: transform 0.2s;
        }
        .sos-fab:hover { transform: scale(1.1); }
        .sos-fab i { color: white; font-size: 1.8rem; }
        @keyframes pulse-red { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 0, 60, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(255, 0, 60, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 0, 60, 0); } }

        /* --- CHATBOT FLOATING BUTTON --- */
        .chat-fab {
            position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px; background: rgba(10, 10, 10, 0.9); border-radius: 50%;
            display: flex; justify-content: center; align-items: center; box-shadow: 0 0 20px rgba(0, 210, 255, 0.3); z-index: 2000; cursor: pointer;
            border: 2px solid var(--neon-blue); transition: all 0.3s ease;
        }
        .chat-fab:hover { transform: scale(1.1); background: rgba(0, 210, 255, 0.1); box-shadow: 0 0 30px rgba(0, 210, 255, 0.5); }
        .chat-fab i { color: var(--neon-blue); font-size: 1.8rem; }

        /* --- CHATBOT PANEL UI --- */
        .qa-panel {
            display: none; position: fixed; bottom: 110px; right: 30px; width: 340px; max-height: 500px; background: rgba(15, 15, 15, 0.95);
            border: 1px solid var(--neon-blue); border-radius: 20px; padding: 20px; z-index: 10006; box-shadow: 0 10px 40px rgba(0,0,0,0.8); backdrop-filter: blur(20px);
            animation: slideUpChat 0.3s ease-out; font-family: 'Open Sans', sans-serif;
        }
        @keyframes slideUpChat { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .qa-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; font-family: 'Open Sans', sans-serif; outline: none; transition: 0.3s; }
        .qa-input:focus { border-color: var(--neon-blue); background: rgba(0, 210, 255, 0.05); }
        .qa-chat-box { height: 300px; overflow-y: auto; margin-bottom: 15px; padding: 10px; border-radius: 10px; background: rgba(0,0,0,0.5); font-size: 0.9rem; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; padding: 10px 14px; border-radius: 12px; max-width: 85%; line-height: 1.4; }
        .msg-bot { background: rgba(0, 210, 255, 0.1); color: var(--neon-blue); align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-user { background: rgba(255,255,255,0.1); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .close-chat { cursor: pointer; color: var(--text-muted); transition: 0.3s; font-size: 1.2rem; }
        .close-chat:hover { color: var(--neon-red); }

        /* --- REPORT MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 3000; display: none;
            justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(8px);
        }
        .modal-content {
            background: linear-gradient(135deg, rgba(30,30,30,0.95), rgba(50,50,50,0.95)); border: 2px solid var(--danger-red); width: 100%; max-width: 900px; max-height: 90vh;
            overflow-y: auto; border-radius: 30px; padding: 30px; position: relative; box-shadow: 0 0 60px rgba(255, 0, 60, 0.4); animation: slideUp 0.4s ease;
        }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal {
            position: absolute; top: 20px; right: 25px; color: #fff; font-size: 1.5rem; cursor: pointer; background: rgba(255,255,255,0.1); width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; transition: 0.3s;
        }
        .close-modal:hover { background: var(--danger-red); }

        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 20px; }
        @media(max-width: 768px) { .report-grid { grid-template-columns: 1fr; } }
        .danger-label { color: var(--danger-red); font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; display: block; letter-spacing: 1px; text-transform: uppercase; font-family: 'Montserrat', sans-serif; }
        .danger-input { width: 100%; background: rgba(0, 0, 0, 0.4); border: 1px solid #777; color: #fff; padding: 12px; margin-bottom: 12px; border-radius: 8px; font-family: 'Open Sans', sans-serif; outline: none; transition: 0.3s; }
        .danger-input:focus { border-color: var(--danger-red); background: rgba(50, 0, 0, 0.5); }
        .submit-btn { background: var(--danger-red); color: white; border: none; width: 100%; padding: 15px; font-weight: 700; border-radius: 30px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; margin-top: 10px; font-family: 'Montserrat', sans-serif; }
        .submit-btn:hover { background: #ff3366; box-shadow: 0 0 25px var(--danger-red); transform: scale(1.02); }
        .action-btn.red-mode { border-color: var(--danger-red); color: var(--danger-red); }
        .action-btn.red-mode:hover { background: rgba(255,0,60,0.1); }
        #report-map { height: 300px; width: 100%; border-radius: 24px; border: 1px solid var(--danger-red); }
        
        /* --- GREEN NAV UI OVERRIDES --- */
        .leaflet-routing-container { background-color: rgba(15, 15, 15, 0.9) !important; color: #fff !important; border: 1px solid var(--neon-blue) !important; border-radius: 12px !important; backdrop-filter: blur(10px); }
        .leaflet-routing-alt { border-bottom: 1px solid rgba(255,255,255,0.1) !important; }
        .leaflet-routing-alt-minimized { color: #aaa !important; }
        
        .external-map-container { width: 100%; height: 70vh; border-radius: 24px; overflow: hidden; border: 1px solid var(--glass-border); background: #fff; }
        .pulse-dot { width: 14px; height: 14px; background-color: var(--neon-green); border-radius: 50%; display: inline-block; box-shadow: 0 0 0 0 rgba(0, 255, 157, 0.7); animation: pulse-green 1.5s infinite; }
        @keyframes pulse-green { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 255, 157, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 12px rgba(0, 255, 157, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 255, 157, 0); } }

        /* --- EV DASHBOARD UI (REUSED FOR LIVE REPORTS) --- */
        .ev-dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%; margin-bottom: 25px; }
        .ev-stat-card { background: linear-gradient(135deg, rgba(20,20,20,0.8), rgba(10,10,10,0.9)); border: 1px solid var(--glass-border); border-radius: 20px; padding: 25px 20px; text-align: center; backdrop-filter: blur(10px); position: relative; overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; }
        .ev-stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 210, 255, 0.1); border-color: rgba(255,255,255,0.2); }
        .ev-stat-card .watermark { position: absolute; right: -15px; top: -15px; font-size: 6rem; opacity: 0.03; z-index: 0; }
        .ev-stat-card h3 { font-size: 2.2rem; margin: 10px 0 5px 0; font-family: 'Montserrat', sans-serif; color: #fff; position: relative; z-index: 1; }
        .ev-stat-card p { margin: 0; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; font-weight: 700; position: relative; z-index: 1; }
        .ev-trend { margin-top: 12px; font-size: 0.8rem; font-weight: 600; font-family: 'Open Sans', sans-serif; position: relative; z-index: 1; }
        
        .ev-main-container { display: flex; gap: 20px; width: 100%; height: auto; min-height: 60vh; }
        .ev-map-enhanced { height: 100%; min-height: 450px; border-radius: 24px; border: 1px solid var(--neon-blue); box-shadow: 0 0 20px rgba(0, 210, 255, 0.1); z-index: 1; }
        
        .ev-sidebar { flex: 1; background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 24px; padding: 20px; overflow-y: auto; max-height: 550px; backdrop-filter: blur(10px); display: flex; flex-direction: column; }
        .ev-sidebar::-webkit-scrollbar { width: 6px; }
        .ev-sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        
        .ev-search-input { width: 100%; padding: 12px 15px 12px 40px; background: rgba(0,0,0,0.6); border: 1px solid var(--glass-border); color: #fff; border-radius: 12px; outline: none; font-family: 'Open Sans', sans-serif; transition: 0.3s; }
        .ev-search-input:focus { border-color: var(--neon-blue); background: rgba(0, 210, 255, 0.05); }

        .ev-list-item { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; }
        .ev-list-item:hover { border-color: var(--neon-blue); background: rgba(0,210,255,0.05); transform: translateX(5px); }
        .ev-list-item h5 { margin: 0 0 5px 0; font-family: 'Montserrat', sans-serif; font-size: 1.05rem; color: #fff; }
        .ev-list-item p { margin: 0; font-size: 0.85rem; color: #aaa; }
        
        .ev-status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
        .status-avail { background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }
        .status-busy { background: var(--neon-yellow); box-shadow: 0 0 8px var(--neon-yellow); }
        .status-down { background: var(--danger-red); box-shadow: 0 0 8px var(--danger-red); }
        .ev-badge { font-size: 0.7rem; font-family: 'Montserrat', sans-serif; font-weight: 700; padding: 4px 8px; border-radius: 6px; display: inline-flex; align-items: center; gap: 4px; }
        .ev-badge-power { background: rgba(0, 210, 255, 0.1); color: var(--neon-blue); border: 1px solid rgba(0, 210, 255, 0.3); }
        .ev-badge-conn { background: rgba(241, 196, 15, 0.1); color: var(--neon-yellow); border: 1px solid rgba(241, 196, 15, 0.3); }

        @media(max-width: 900px) {
            .ev-dashboard { grid-template-columns: 1fr; }
            .ev-main-container { flex-direction: column; height: auto; }
            .ev-map-enhanced { height: 400px; }
            .ev-sidebar { max-height: 400px; }
        }

        .grap-list { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 15px; }
        .grap-item { background: linear-gradient(90deg, rgba(20,20,20,0.8) 0%, rgba(20,20,20,0.4) 100%); border-left: 4px solid var(--neon-red); padding: 20px; cursor: pointer; border-radius: 12px; transition: 0.3s; }
        .grap-item:hover { background: rgba(255, 0, 0, 0.05); }
        .grap-content { display: none; margin-top: 15px; color: #ccc; font-size: 1rem; line-height: 1.6; }
        .grap-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1.1rem; font-family: 'Montserrat', sans-serif; }
        .stat-bar { display: flex; justify-content: space-between; background: #222; padding: 15px; border-radius: 12px; width: 100%; max-width: 800px; margin-bottom: 20px; border: 1px solid var(--glass-border); }

        .chart-container { height: 300px; width: 100%; position: relative; display: flex; justify-content: center; align-items: center; }
        #pollutantChart { filter: drop-shadow(0 0 10px rgba(0, 255, 157, 0.1)); }
        .cause-list { list-style: none; line-height: 2.2; font-size: 1.1rem; }
        .cause-list i { margin-right: 12px; width: 20px; text-align: center; }

        .causes-swap-container { position: relative; width: 100%; height: 210px; }
        .cause-list-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: opacity 0.4s ease, visibility 0.4s; }
        .causes-chart-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s; }
        #causes:hover .cause-list-wrapper { opacity: 0; visibility: hidden; }
        #causes:hover .causes-chart-wrapper { opacity: 1; visibility: visible; }

        /* --- FLOATING BALLOON --- */
        .neon-balloon { position: fixed; bottom: -100px; left: 30px; width: 60px; height: 75px; background: var(--neon-blue); border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 10000; box-shadow: 0 0 25px var(--neon-blue); border: 2px solid rgba(255, 255, 255, 0.5); color: #fff; font-size: 1.5rem; animation: floatUp 12s linear infinite; }
        .neon-balloon::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 2px; height: 20px; background: rgba(255, 255, 255, 0.3); }
        @keyframes floatUp { 0% { bottom: -100px; transform: translateX(0); } 25% { transform: translateX(15px) rotate(5deg); } 50% { transform: translateX(-15px) rotate(-5deg); } 75% { transform: translateX(10px) rotate(3deg); } 100% { bottom: 110vh; transform: translateX(0); } }

        .fact-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(15px); border: 1px solid var(--neon-blue); border-radius: 20px; padding: 25px; z-index: 10001; box-shadow: 0 0 50px rgba(0, 210, 255, 0.3); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        .fact-popup h4 { color: var(--neon-blue); margin-bottom: 15px; font-family: 'Montserrat', sans-serif; display: flex; justify-content: space-between; }
        .close-fact { cursor: pointer; color: var(--text-muted); }
        .close-fact:hover { color: var(--neon-red); }

        /* --- INSIGHTS / AWARENESS STYLES --- */
        .btn-group { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;}
        .season-btn { margin-right: 10px; }
        .timeline { display: flex; overflow-x: auto; width: 100%; margin-bottom: 20px; gap: 15px; padding-bottom: 10px; scroll-snap-type: x proximity; scroll-behavior: smooth; }
        .timeline::-webkit-scrollbar { height: 8px; }
        .timeline::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
        .timeline::-webkit-scrollbar-thumb { background: var(--neon-blue); border-radius: 10px; }
        
        .timeline-event { min-width: 260px; text-align: center; background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 24px; padding: 20px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); transition: transform 0.3s ease, box-shadow 0.4s ease; display: flex; flex-direction: column; align-items: center; scroll-snap-align: start; }
        .timeline-event:hover { transform: translateY(-5px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); }
        .timeline-event span { font-family: 'Montserrat', sans-serif; font-size: 1.2rem; font-weight: 800; text-transform: uppercase; margin-bottom: 10px; }
        .timeline-event p { margin: 5px 0; font-family: 'Open Sans', sans-serif; }
        .timeline-event p:nth-child(2) { font-weight: 700; color: #fff; }
        .timeline-event p:nth-child(3) { font-weight: bold; font-size: 1.05rem; }
        .timeline-event p:nth-child(4) { color: #ccc; font-size: 0.95rem; line-height: 1.5; }
        
        .timeline-progress { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 10px; }
        .progress-bar { height: 100%; background: var(--neon-blue); width: 0; transition: width 0.3s; border-radius: 2px; }
        
        .quiz-question { margin-bottom: 20px; font-family: 'Open Sans', sans-serif; font-size: 1.05rem; }
        .quiz-question p { font-family: 'Montserrat', sans-serif; font-weight: 700; margin-bottom: 10px; color: #fff; }
        .quiz-option { display: block; margin-bottom: 8px; cursor: pointer; color: var(--text-muted); transition: color 0.3s; }
        .quiz-option:hover { color: #fff; }
        #quiz-feedback { margin-top: 20px; color: var(--neon-green); font-family: 'Montserrat', sans-serif; font-weight: 700; line-height: 1.6; }
    </style>
</head>
<body>

    <header id="top-banner">
        <video src="WhatsApp Video 2026-02-20 at 02.48.00.mp4" autoplay loop muted playsinline></video>
        <div class="banner-content">
            <img src="https://i.pinimg.com/736x/c1/f8/3c/c1f83c3d95fd102755f7cc3ed00cbf62.jpg" class="banner-logo" alt="Aerova Circular Logo">
            <div class="banner-text">
                <h1 class="banner-title">AEROVA</h1>
                <p class="banner-quote">Giving a voice to the Air</p>
            </div>
        </div>
    </header>

    <nav>
        <a onclick="switchTab('home')" id="nav-home" class="active"><i class="fas fa-home"></i> Home</a>
        <a onclick="switchTab('navigation')" id="nav-navigation"><i class="fas fa-route"></i> Green Nav</a>
        <a onclick="switchTab('maps')" id="nav-maps"><i class="fas fa-map-marked-alt"></i> Zones</a>
        <a onclick="switchTab('rules')" id="nav-rules"><i class="fas fa-gavel"></i> GRAP</a>
        <a onclick="switchTab('ev')" id="nav-ev"><i class="fas fa-bolt"></i> EV Grid</a>
        <a onclick="switchTab('reports')" id="nav-reports"><i class="fas fa-tower-broadcast"></i> Live SOS</a>
        <a onclick="switchTab('awareness')" id="nav-awareness"><i class="fas fa-lightbulb"></i> Insights</a>
    </nav>

    <div class="neon-balloon" id="balloonBtn" onclick="handleBalloonPop()">
        <i class="fas fa-lightbulb"></i>
    </div>

    <div class="fact-popup" id="factPopup">
        <h4><i class="fas fa-bolt"></i> IMPACT DATA <i class="fas fa-times close-fact" onclick="closeFact()"></i></h4>
        <p id="factText" style="line-height: 1.6; color: #fff;"></p>
    </div>

    <div class="sos-fab" onclick="openReportModal()" title="Report Hazard">
        <i class="fas fa-exclamation-triangle"></i>
    </div>

    <div class="chat-fab" onclick="toggleChatPanel()" title="वायुexa">
        <i class="fas fa-comments"></i>
    </div>

    <div id="chatPanel" class="qa-panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items: center;">
            <h4 style="color: var(--neon-blue); font-family: 'Montserrat', sans-serif; margin: 0; font-size: 1.1rem;"><i class="fas fa-robot"></i> वायुexa AI</h4>
            <i class="fas fa-times close-chat" onclick="toggleChatPanel()"></i>
        </div>
        <div class="qa-chat-box" id="chatWindow">
            <div class="msg msg-bot">Hello! I’m Vayuxa, your personal air quality guardian powered by Mistral AI. I track the invisible so you can breathe clearly.</div>
            <div class="msg msg-bot">Ask me about Health, General Awareness, City Updates, or Prevention Solutions!</div>
        </div>
        <div style="display:flex; gap:8px;">
            <input type="text" id="chatInput" class="qa-input" placeholder="Type a message..." style="margin-bottom:0;" onkeypress="handleChatEnter(event)">
            <button class="action-btn" onclick="sendChatMsg()" style="padding:10px 15px; border-color: var(--neon-blue); color: var(--neon-blue);"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="report-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="close-modal" onclick="closeReportModal()">×</div>
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="margin:0; font-size: 1.8rem; background: none; -webkit-text-fill-color: var(--danger-red);"><i class="fas fa-radiation"></i> EMERGENCY REPORT</h2>
                <p style="color:#aaa; font-size: 0.9rem;">Submit hazardous incidents directly to Central Command.</p>
            </div>
            <div class="report-grid">
                <div>
                    <div class="danger-label"><i class="fas fa-crosshairs"></i> PINPOINT INCIDENT</div>
                    <div id="report-map"></div>
                    <button class="action-btn red-mode" onclick="traceIncidentPath()" style="width:100%; margin-top:10px;">
                        <i class="fas fa-route"></i> Trace Path (Me -> Incident)
                    </button>
                    <div style="margin-top:10px; font-size: 0.8rem; color:#aaa;">
                        <i class="fas fa-info-circle"></i> Click map to auto-fill location.
                    </div>
                </div>
                <form onsubmit="submitReport(event)">
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;"><label class="danger-label">First Name *</label><input type="text" id="report-fname" class="danger-input" required></div>
                        <div style="flex:1;"><label class="danger-label">Last Name</label><input type="text" class="danger-input"></div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;"><label class="danger-label">Email ID *</label><input type="email" class="danger-input" required></div>
                        <div style="flex:1;"><label class="danger-label">Mobile</label><input type="tel" class="danger-input"></div>
                    </div>
                    <label class="danger-label">Location Coordinates *</label>
                    <input type="text" id="incident-loc-text" class="danger-input" placeholder="Click map..." readonly required>
                    <label class="danger-label">Hazard Type</label>
                    <select id="report-hazard-type" class="danger-input" required>
                        <option value="">Select Incident...</option>
                        <option value="Major Accident">Major Accident</option>
                        <option value="Zero Visibility Smog">Zero Visibility Smog</option>
                        <option value="Toxic Fire">Toxic Fire</option>
                    </select>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                        <div id="captcha-display" style="background:#400; padding:10px; color:#fff; letter-spacing:3px; font-family:'Montserrat', sans-serif; border:1px dashed red;">ABCD</div>
                        <input type="text" id="captcha-input" class="danger-input" placeholder="Enter Code" style="margin:0;" required>
                    </div>
                    <button type="submit" class="submit-btn"><i class="fas fa-paper-plane"></i> TRANSMIT REPORT</button>
                </form>
            </div>
        </div>
    </div>

    <section id="home" class="active-section">
        <div id="location-box" class="location-badge">
            <i class="fas fa-satellite-dish"></i> Fetching Live Network...
        </div>

        <div class="aqi-wrapper">
            <svg class="aqi-svg">
                <circle class="aqi-circle-bg" cx="160" cy="160" r="140"></circle>
                <circle class="aqi-circle-progress" id="aqi-progress-bar" cx="160" cy="160" r="140"></circle>
            </svg>
            <div class="aqi-inner-content">
                <span class="aqi-number" id="main-aqi">--</span>
                <span class="aqi-label">AQI (LIVE)</span>
            </div>
        </div>
        
        <h3 id="aqi-text" style="color: var(--neon-red); letter-spacing: 2px; margin-bottom: 20px;">FETCHING LIVE AIR...</h3>

        <div id="weather-metrics" style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 40px; background: rgba(20, 20, 20, 0.8); border: 1px solid var(--glass-border); border-radius: 20px; padding: 15px 25px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 700px; width: 100%;">
            
            <div class="weather-metric-item metric-temp">
                <i class="fas fa-thermometer-half" style="color: var(--neon-red); font-size: 1.5rem; margin-bottom: 8px;"></i>
                <div style="font-size: 0.85rem; color: var(--text-muted); font-family: 'Montserrat', sans-serif; font-weight: 700;">TEMP</div>
                <strong id="live-temp" style="font-size: 1.2rem; font-family: 'Open Sans', sans-serif; color: #fff;">-- °C</strong>
            </div>
            
            <div class="weather-divider" style="width: 1px; background: rgba(255,255,255,0.1); min-height: 50px;"></div>
            
            <div class="weather-metric-item metric-humidity">
                <i class="fas fa-tint" style="color: var(--neon-blue); font-size: 1.5rem; margin-bottom: 8px;"></i>
                <div style="font-size: 0.85rem; color: var(--text-muted); font-family: 'Montserrat', sans-serif; font-weight: 700;">HUMIDITY</div>
                <strong id="live-humidity" style="font-size: 1.2rem; font-family: 'Open Sans', sans-serif; color: #fff;">-- %</strong>
            </div>
            
            <div class="weather-divider" style="width: 1px; background: rgba(255,255,255,0.1); min-height: 50px;"></div>
            
            <div class="weather-metric-item metric-wind">
                <i class="fas fa-wind" style="color: #a8ff00; font-size: 1.5rem; margin-bottom: 8px;"></i>
                <div style="font-size: 0.85rem; color: var(--text-muted); font-family: 'Montserrat', sans-serif; font-weight: 700;">WIND SPEED</div>
                <strong id="live-wind" style="font-size: 1.2rem; font-family: 'Open Sans', sans-serif; color: #fff;">-- km/h</strong>
            </div>
            
            <div class="weather-divider" style="width: 1px; background: rgba(255,255,255,0.1); min-height: 50px;"></div>
            
            <div class="weather-metric-item metric-air">
                <i class="fas fa-leaf" style="color: var(--neon-green); font-size: 1.5rem; margin-bottom: 8px;"></i>
                <div style="font-size: 0.85rem; color: var(--text-muted); font-family: 'Montserrat', sans-serif; font-weight: 700;">AIR QUALITY</div>
                <strong id="live-air-qual" style="font-size: 1.1rem; font-family: 'Open Sans', sans-serif; color: #fff;">--</strong>
            </div>

        </div>

        <div class="dashboard-grid">
            <div class="glass-card" id="composition">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-chart-pie"></i> Pollutant Mix</h4>
                <div class="chart-container">
                    <canvas id="pollutantChart"></canvas>
                </div>
            </div>

            <div class="glass-card" id="causes">
                <h4 style="margin-bottom: 15px; color: var(--neon-yellow);"><i class="fas fa-exclamation-triangle"></i> Primary Causes</h4>
                
                <div class="causes-swap-container">
                    <div class="cause-list-wrapper">
                        <ul class="cause-list">
                            <li><i class="fas fa-car-side"></i> <strong>Vehicular Emissions</strong> (41%)</li>
                            <li><i class="fas fa-trowel-bricks"></i> <strong>Construction Dust</strong> (21%)</li>
                            <li><i class="fas fa-industry"></i> <strong>Industrial Waste</strong> (18%)</li>
                            <li><i class="fas fa-fire"></i> <strong>Farm Fires</strong> (Stubble) (15%)</li>
                        </ul>
                    </div>
                    
                    <div class="causes-chart-wrapper">
                        <canvas id="causesChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-card" id="precautions">
                <h4 style="margin-bottom: 15px; color: var(--neon-green);"><i class="fas fa-shield-virus"></i> Safety Protocol</h4>
                <ul class="cause-list">
                    <li><i class="fas fa-mask"></i> Wear <strong>N95 Masks</strong> outdoors</li>
                    <li><i class="fas fa-window-close"></i> Keep windows closed post 5 PM</li>
                    <li><i class="fas fa-running"></i> Avoid outdoor cardio</li>
                    <li><i class="fas fa-leaf"></i> Use HEPA Air Purifiers</li>
                </ul>
            </div>
        </div>
    </section>

    <section id="navigation">
        <h2>Eco-Smart Navigation</h2>
        <p style="text-align: center; color: var(--text-muted); margin-bottom: 25px;">Live GPS routing avoiding high-pollution hotspots.</p>
        
        <div class="dashboard-grid" style="grid-template-columns: 1fr; max-width: 1000px; margin-top: 10px;">
            <div class="glass-card" style="padding: 0; overflow: hidden; border-color: var(--neon-blue);">
                <div style="padding: 20px; background: rgba(0,0,0,0.4); display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 280px;">
                        <label style="color: var(--neon-blue); font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; display: block; text-transform: uppercase; font-family: 'Montserrat', sans-serif;"><i class="fas fa-search-location"></i> Destination</label>
                        <input type="text" id="nav-dest-input" placeholder="Enter any city, state, or street (Gali) in India..." style="width: 100%; background: rgba(0, 0, 0, 0.4); border: 1px solid #777; color: #fff; padding: 12px; border-radius: 8px; font-family: 'Open Sans', sans-serif; outline: none; transition: 0.3s; margin-bottom: 0;">
                    </div>
                    <button class="action-btn" id="nav-route-btn" onclick="calculateGreenRoute()" style="margin-top: 22px; border-color: var(--neon-green); color: var(--neon-green); padding: 12px 25px;">
                        <i class="fas fa-location-arrow"></i> Find Cleanest Path
                    </button>
                </div>
                
                <div id="nav-map-container" style="height: 550px; width: 100%; border-top: 1px solid var(--glass-border);"></div>
                
                <div id="route-stats" style="display: none; padding: 25px; background: rgba(5,5,5,0.9); grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; border-top: 1px solid var(--neon-green);">
                    <div style="border-left: 4px solid #28a745; padding-left: 20px;">
                        <h5 style="color: #28a745; margin: 0; font-family: 'Montserrat';">GREEN ROUTE</h5>
                        <p id="green-path-info" style="font-size: 0.9rem; margin-top: 10px; color: #fff; line-height: 1.6;"></p>
                    </div>
                    <div style="border-left: 4px solid var(--danger-red); padding-left: 20px;">
                        <h5 style="color: var(--danger-red); margin: 0; font-family: 'Montserrat';">FASTEST ROUTE</h5>
                        <p id="fast-path-info" style="font-size: 0.9rem; margin-top: 10px; color: #fff; line-height: 1.6;"></p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="maps">
        <h2>Live Air Quality Zones</h2>
        <div class="external-map-container">
            <iframe 
                src="https://www.aqi.in/in/air-quality-map?map_type=aqi&loc_slug=india" 
                style="border:none; width:100%; height:calc(100% + 160px); margin-top: -160px;"
                title="AQI India Map">
            </iframe>
        </div>
    </section>

    <section id="rules">
        <h2>GRAP Protocols</h2>
        <div class="stat-bar" id="grap-top-bar" style="transition: all 0.4s ease;">
            <div>
                <span style="color: var(--text-muted); font-size: 0.8rem; font-family:'Montserrat',sans-serif; font-weight:700;">CURRENT STAGE (LIVE AQI)</span><br>
                <strong id="grap-stage-display" style="color: var(--neon-green); font-size: 1.2rem; font-family:'Montserrat',sans-serif;">CALCULATING...</strong>
            </div>
            <div style="text-align: right;">
                <span style="color: var(--text-muted); font-size: 0.8rem; font-family:'Montserrat',sans-serif; font-weight:700;">ACTIVE FINES</span><br>
                <strong id="grap-fine-display" style="color: #fff; font-size: 1.2rem; font-family:'Montserrat',sans-serif;">...</strong>
            </div>
        </div>

        <div class="glass-card" style="margin-bottom: 30px; border-color: var(--neon-blue); box-shadow: 0 0 20px rgba(0, 210, 255, 0.05); max-width: 800px; width: 100%;">
            <h4 style="color: var(--neon-blue); border-bottom-color: rgba(0, 210, 255, 0.2);">
                <i class="fas fa-car-side"></i> Check Your Vehicle Status
            </h4>
            <p style="color: #ccc; font-size: 0.95rem; margin-bottom: 25px; line-height: 1.6;">
                Select your vehicle's manufacturer, model, year, and fuel type to check if it is allowed to operate under the current Graded Response Action Plan (GRAP) stage based on the <strong style="color:var(--neon-blue);">Live AQI Data</strong> in Delhi NCR.
            </p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div>
                    <label class="danger-label" style="color: var(--neon-blue);">
                        <span style="background: var(--neon-blue); color: #000; border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 5px;">1</span> Manufacturer
                    </label>
                    <select class="danger-input" id="grap-manufacturer" style="margin-bottom: 0;" onchange="updateModels()">
                        <option value="">Select manufacturer...</option>
                    </select>
                </div>
                <div>
                    <label class="danger-label" style="color: var(--neon-blue);">
                        <span style="background: var(--neon-blue); color: #000; border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 5px;">2</span> Model
                    </label>
                    <select class="danger-input" id="grap-model" style="margin-bottom: 0; opacity: 0.6;" disabled onchange="updateYears()">
                        <option value="">Select manufacturer first</option>
                    </select>
                </div>
                <div>
                    <label class="danger-label" style="color: var(--neon-blue);">
                        <span style="background: var(--neon-blue); color: #000; border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 5px;">3</span> Year
                    </label>
                    <select class="danger-input" id="grap-year" style="margin-bottom: 0; opacity: 0.6;" disabled onchange="updateFuel()">
                        <option value="">Select model first</option>
                    </select>
                </div>
                <div>
                    <label class="danger-label" style="color: var(--neon-blue);">
                        <span style="background: var(--neon-blue); color: #000; border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 5px;">4</span> Fuel Type
                    </label>
                    <select class="danger-input" id="grap-fuel" style="margin-bottom: 0; opacity: 0.6;" disabled>
                        <option value="">Select year first</option>
                    </select>
                </div>
            </div>

            <button class="action-btn" onclick="checkVehicleStatus()" style="width: 100%; border-color: var(--neon-blue); background: rgba(0, 210, 255, 0.1); color: var(--neon-blue); margin-bottom: 25px; padding: 14px; font-size: 1rem; border-radius: 12px;">
                Check Restriction Status (Live Sync)
            </button>

            <div id="grap-result-box" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 25px; font-family: 'Open Sans', sans-serif; line-height: 1.5; transition: all 0.3s ease;"></div>

            <div style="background: rgba(241, 196, 15, 0.05); border-left: 4px solid var(--neon-yellow); padding: 15px; border-radius: 8px;">
                <h5 style="color: var(--neon-yellow); font-family: 'Montserrat', sans-serif; margin-bottom: 8px; font-size: 0.95rem;">
                    Important Notice
                </h5>
                <p style="color: #aaa; font-size: 0.85rem; line-height: 1.6; margin: 0;">
                    Vehicle restrictions automatically reflect the CAQM GRAP guidelines driven by the Live AQI dashboard. Non-compliance may result in penalties under the Motor Vehicles Act.
                </p>
            </div>
        </div>
        <div class="grap-list">
            <div class="grap-item" onclick="toggleGrap(this)">
                <div class="grap-header">
                    <span><i class="fas fa-ban"></i> Vehicle Bans & Restrictions</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="grap-content" id="grap-vehicle-text">
                    <i class="fas fa-spinner fa-spin"></i> Syncing with Live AQI...
                </div>
            </div>

            <div class="grap-item" onclick="toggleGrap(this)">
                <div class="grap-header">
                    <span><i class="fas fa-hard-hat"></i> Construction & Demolition</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="grap-content" id="grap-const-text">
                    <i class="fas fa-spinner fa-spin"></i> Syncing with Live AQI...
                </div>
            </div>

            <div class="grap-item" onclick="toggleGrap(this)">
                <div class="grap-header">
                    <span><i class="fas fa-smog"></i> Industrial & Generator Operations</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="grap-content" id="grap-ind-text">
                    <i class="fas fa-spinner fa-spin"></i> Syncing with Live AQI...
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="action-btn" onclick="window.open('https://caqm.nic.in/', '_blank')">Download CAQM Official Guidelines</button>
            </div>
        </div>
    </section>

    <section id="ev">
        <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom: 5px;">
            <div class="pulse-dot"></div>
            <span style="color: var(--neon-green); font-weight:700; letter-spacing:1px; font-family:'Montserrat',sans-serif; font-size: 0.9rem;">LIVE NETWORK ACTIVE</span>
        </div>
        
        <h2><i class="fas fa-bolt" style="color: var(--neon-yellow); margin-right: 10px;"></i> EV Charging Grid</h2>
        <p style="margin-bottom: 25px; color: var(--text-muted); text-align: center;">Real-Time Availability & Network Analytics</p>
        
        <div class="ev-dashboard">
            <div class="ev-stat-card">
                <i class="fas fa-charging-station watermark"></i>
                <i class="fas fa-charging-station" style="font-size: 2rem; color: var(--neon-blue);"></i>
                <h3>142</h3>
                <p>Active Hubs</p>
                <div class="ev-trend" style="color: var(--neon-green);"><i class="fas fa-arrow-up"></i> 12% vs last month</div>
            </div>
            <div class="ev-stat-card">
                <i class="fas fa-plug watermark"></i>
                <i class="fas fa-plug" style="font-size: 2rem; color: var(--neon-green);"></i>
                <h3>56</h3>
                <p>Available Ports</p>
                <div class="ev-trend" style="color: var(--neon-green);"><i class="fas fa-arrow-up"></i> 4% vs yesterday</div>
            </div>
            <div class="ev-stat-card">
                <i class="fas fa-leaf watermark"></i>
                <i class="fas fa-leaf" style="font-size: 2rem; color: var(--neon-yellow);"></i>
                <h3>1.2k</h3>
                <p>Tons CO₂ Saved</p>
                <div class="ev-trend" style="color: var(--neon-yellow);"><i class="fas fa-chart-line"></i> Steady Growth</div>
            </div>
        </div>

        <div class="ev-main-container">
            <div style="flex:2; display:flex; flex-direction:column; gap:20px;">
                <div id="ev-map" class="ev-map-enhanced"></div>
                
                <div class="glass-card" style="padding:20px; display:flex; justify-content:space-between; align-items:center; background: linear-gradient(90deg, rgba(0,210,255,0.05), rgba(0,255,157,0.05)); border-color:var(--neon-blue);">
                    <div>
                        <h5 style="margin:0; font-family:'Montserrat', sans-serif; color:#fff; font-size:1.1rem;"><i class="fas fa-tree" style="color:var(--neon-green); margin-right: 8px;"></i> Environmental Impact</h5>
                        <p style="margin:5px 0 0 0; color:#aaa; font-size:0.9rem; line-height: 1.5;">The Delhi EV network has offset equivalent emissions of planting <strong style="color:#fff;">54,000 trees</strong> this year alone.</p>
                    </div>
                </div>
            </div>
            
            <div class="ev-sidebar">
                <div style="margin-bottom:20px; position:relative;">
                    <input type="text" placeholder="Search locations or networks..." class="ev-search-input">
                    <i class="fas fa-search" style="position:absolute; left:15px; top:14px; color:var(--text-muted);"></i>
                </div>
                
                <h4 style="font-family:'Montserrat', sans-serif; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:15px; color:#fff; font-size: 1.1rem;">
                    <i class="fas fa-list-ul"></i> Nearby Stations
                </h4>
                <div id="ev-list"></div>
            </div>
        </div>
    </section>

    <section id="reports">
        <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom: 5px;">
            <div class="pulse-dot" style="background-color: var(--neon-orange); box-shadow: 0 0 0 0 rgba(255, 159, 67, 0.7); animation: pulse-orange 1.5s infinite;"></div>
            <span style="color: var(--neon-orange); font-weight:700; letter-spacing:1px; font-family:'Montserrat',sans-serif; font-size: 0.9rem;">COMMUNITY RADAR</span>
            <style>@keyframes pulse-orange { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 159, 67, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 12px rgba(255, 159, 67, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 159, 67, 0); } }</style>
        </div>
        
        <h2><i class="fas fa-tower-broadcast" style="color: var(--neon-orange); margin-right: 10px;"></i> Live SOS Feed</h2>
        <p style="text-align: center; color: var(--text-muted); margin-bottom: 25px;">Real-time community-reported hazards. Volunteer to help or avoid these active incident areas.</p>
        
        <div class="ev-main-container">
            <div style="flex:2; display:flex; flex-direction:column; gap:20px;">
                <div id="live-reports-map" class="ev-map-enhanced" style="border-color: var(--neon-orange); box-shadow: 0 0 20px rgba(255, 159, 67, 0.1);"></div>
            </div>
            
            <div class="ev-sidebar" style="border-color: var(--neon-orange);">
                <h4 style="font-family:'Montserrat', sans-serif; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:15px; color:#fff; font-size: 1.1rem;">
                    <i class="fas fa-exclamation-circle" style="color: var(--danger-red);"></i> Active Incidents
                </h4>
                <div id="live-reports-list"></div>
            </div>
        </div>
    </section>

    <section id="awareness">
        <h2>Awareness & Insights</h2>
        <div class="dashboard-grid">
            <div class="glass-card" id="topography-sim" style="grid-column: 1 / -1;">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-mountain"></i> Delhi Topography & Pollution Simulation</h4>
                
                <div class="btn-group">
                    <button class="action-btn season-btn active" id="btn-winter" onclick="setSeason('winter')">Winter Smog</button>
                    <button class="action-btn season-btn" id="btn-summer" onclick="setSeason('summer')">Summer Dispersal</button>
                </div>

                <div id="video-sim-container" style="margin-bottom: 0; position: relative; border-radius: 12px; border: 1px solid var(--glass-border); box-shadow: 0 8px 32px rgba(0,0,0,0.5); overflow: hidden;">
                    
                    <div id="winter-wrapper" style="position: relative; width: 100%; display: block; cursor: pointer;" onclick="playSim('winter')">
                        <video id="winter-vid" src="Delhi_Winter_Smog_Simulation_Video.mp4" 
                               style="width: 100%; height: auto; display: block; filter: blur(12px); transition: filter 0.5s ease;" 
                               loop muted playsinline>
                        </video>
                        <div id="winter-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); color: #fff; font-family: 'Montserrat', sans-serif; transition: opacity 0.5s ease; z-index: 10;">
                            <i class="fas fa-play-circle" style="font-size: 3rem; margin-bottom: 10px; color: var(--neon-blue);"></i>
                            <h3 style="margin:0; text-shadow: 0 2px 10px rgba(0,0,0,0.8);">Click to see simulation</h3>
                        </div>
                    </div>
                    
                    <div id="summer-wrapper" style="position: relative; width: 100%; display: none; cursor: pointer;" onclick="playSim('summer')">
                        <video id="summer-vid" src="Pollution_Video_Simulation_Request.mp4" 
                               style="width: 100%; height: auto; display: block; filter: blur(12px); transition: filter 0.5s ease;" 
                               loop muted playsinline>
                        </video>
                        <div id="summer-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); color: #fff; font-family: 'Montserrat', sans-serif; transition: opacity 0.5s ease; z-index: 10;">
                            <i class="fas fa-play-circle" style="font-size: 3rem; margin-bottom: 10px; color: var(--neon-yellow);"></i>
                            <h3 style="margin:0; text-shadow: 0 2px 10px rgba(0,0,0,0.8);">Click to see simulation</h3>
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Simulation Legend & Meaning</h4>
                <div class="dashboard-grid" style="margin-top: 15px;">
                    <div class="glass-card">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-mountain" style="color:#333; font-size:1.5rem;"></i>
                            <h5 style="margin:0; font-family:'Montserrat', sans-serif; font-size: 1.1rem;">Bowl-Shaped Terrain</h5>
                        </div>
                        <p style="margin-top:10px; color:#ccc; font-size: 0.9rem;">Delhi acts like a basin trapping pollutants and cold air close to the ground due to its geographical features.</p>
                    </div>
                    <div class="glass-card">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-layer-group" style="color:var(--neon-blue); font-size:1.5rem;"></i>
                            <h5 style="margin:0; font-family:'Montserrat', sans-serif; font-size: 1.1rem;">Inversion Layer</h5>
                        </div>
                        <p style="margin-top:10px; color:#ccc; font-size: 0.9rem;">Warm air traps cold polluted air below, preventing pollutants from rising and dispersing, especially in winter.</p>
                    </div>
                    <div class="glass-card">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-exclamation-circle" style="color:var(--danger-red); font-size:1.5rem;"></i>
                            <h5 style="margin:0; font-family:'Montserrat', sans-serif; font-size: 1.1rem;">Pollution Hotspots</h5>
                        </div>
                        <p style="margin-top:10px; color:#ccc; font-size: 0.9rem;">Represent areas of high emissions from traffic, industry, and construction where pollutants accumulate rapidly.</p>
                    </div>
                    <div class="glass-card">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-wind" style="color:var(--neon-green); font-size:1.5rem;"></i>
                            <h5 style="margin:0; font-family:'Montserrat', sans-serif; font-size: 1.1rem;">Wind Arrows</h5>
                        </div>
                        <p style="margin-top:10px; color:#ccc; font-size: 0.9rem;">Show weak winds in winter failing to disperse pollutants versus stronger winds in summer aiding dispersal.</p>
                    </div>
                    <div class="glass-card">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-smog" style="color:var(--danger-red); font-size:1.5rem;"></i>
                            <h5 style="margin:0; font-family:'Montserrat', sans-serif; font-size: 1.1rem;">Floating Particles</h5>
                        </div>
                        <p style="margin-top:10px; color:#ccc; font-size: 0.9rem;">Illustrate PM2.5/PM10 behavior; they float slowly and get trapped under inversion layers in winter.</p>
                    </div>
                    <div class="glass-card">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-cloud" style="color:#808080; font-size:1.5rem;"></i>
                            <h5 style="margin:0; font-family:'Montserrat', sans-serif; font-size: 1.1rem;">Grey Overlay</h5>
                        </div>
                        <p style="margin-top:10px; color:#ccc; font-size: 0.9rem;">Depicts winter smog density, increasing pollutant concentration and reducing visibility across Delhi.</p>
                    </div>
                </div>
            </div>

            <div class="glass-card" id="timeline-quiz" style="grid-column: 1 / -1;">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-history"></i> Pollution Timeline</h4>
                <div class="timeline">
                    <div class="timeline-event" style="border-left: 4px solid var(--neon-yellow);"><span>April 2025</span><p>Construction Dust Rise</p><p style="color:var(--neon-yellow)">AQI Increase: +20%</p><p>Post-winter construction activities kick off, raising dust levels across the city.</p></div>
                    <div class="timeline-event" style="border-left: 4px solid var(--neon-yellow);"><span>May 2025</span><p>Heat Waves & Dust</p><p style="color:var(--neon-yellow)">AQI Increase: +15%</p><p>Intense heat and dust storms from Rajasthan worsen air quality.</p></div>
                    <div class="timeline-event" style="border-left: 4px solid var(--neon-blue);"><span>June 2025</span><p>Pre-Monsoon Winds</p><p style="color:var(--neon-blue)">AQI Decrease: -10%</p><p>Winds before monsoon help disperse some accumulated pollutants.</p></div>
                    <div class="timeline-event" style="border-left: 4px solid var(--neon-green);"><span>July 2025</span><p>Monsoon Cleansing</p><p style="color:var(--neon-green)">AQI Decrease: -30%</p><p>Heavy rains wash away pollutants, significantly improving AQI.</p></div>
                    <div class="timeline-event" style="border-left: 4px solid var(--neon-blue);"><span>August 2025</span><p>Rainfall Improvement</p><p style="color:var(--neon-blue)">AQI Decrease: -25%</p><p>Ongoing monsoon reduces emissions and cleans the air further.</p></div>
                    <div class="timeline-event" style="border-left: 4px solid var(--neon-yellow);"><span>September 2025</span><p>Gradual Increase</p><p style="color:var(--neon-yellow)">AQI Increase: +10%</p><p>Post-monsoon, pollution starts building up with reduced rainfall.</p></div>
                    <div class="timeline-event" style="border-left: 4px solid var(--danger-red);"><span>October 2025</span><p>Diwali Spike</p><p style="color:var(--danger-red)">AQI Increase: +30%</p><p>Fireworks during Diwali cause a sharp rise in particulate matter.</p></div>
                    <div class="timeline-event" style="border-left: 4px solid var(--danger-red);"><span>November 2025</span><p>Stubble Burning Peak</p><p style="color:var(--danger-red)">AQI Increase: +50%</p><p>Farm fires in neighboring states blanket Delhi in smoke.</p></div>
                    <div class="timeline-event" style="border-left: 4px solid var(--danger-red);"><span>December 2025</span><p>Temperature Inversion</p><p style="color:var(--danger-red)">AQI Increase: +40%</p><p>Cold weather traps pollutants under inversion layers.</p></div>
                    <div class="timeline-event" style="min-width: 50px; border-left: 4px solid var(--neon-yellow); color: var(--neon-yellow); padding: 10px 0; justify-content:center;"><span>2026</span></div>
                    <div class="timeline-event" style="border-left: 4px solid var(--neon-blue);"><span>January 2026</span><p>GRAP Stage III/IV</p><p style="color:var(--neon-blue)">AQI Decrease: -20%</p><p>Strict GRAP measures enforced to curb emissions and improve air quality.</p></div>
                    <div class="timeline-event" style="border-left: 4px solid var(--neon-blue);"><span>February 2026</span><p>Western Disturbance</p><p style="color:var(--neon-blue)">AQI Decrease: -15%</p><p>Rainfall from western disturbances helps clear the air temporarily.</p></div>
                    <div class="timeline-event" style="border-left: 4px solid var(--neon-green);"><span>March 2026</span><p>Spring Dispersal</p><p style="color:var(--neon-green)">AQI Decrease: -40%</p><p>Warmer winds disperse remaining pollutants effectively as spring arrives.</p></div>
                </div>
                <div class="timeline-progress"><div class="progress-bar"></div></div>
                
                <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 30px 0;">
                
                <h4 style="margin-bottom: 20px;"><i class="fas fa-question-circle"></i> Awareness Knowledge Check</h4>
                <form id="quiz-form">
                    <div class="quiz-question">
                        <p>1. What is the primary contributor to pollution in Delhi according to the data?</p>
                        <label class="quiz-option"><input type="radio" name="q1" value="a"> a) Vehicular Emissions</label>
                        <label class="quiz-option"><input type="radio" name="q1" value="b"> b) Rainfall & Humidity</label>
                        <label class="quiz-option"><input type="radio" name="q1" value="c"> c) Natural Deforestation</label>
                    </div>
                    <div class="quiz-question">
                        <p>2. Why does pollution become severely trapped during winter months?</p>
                        <label class="quiz-option"><input type="radio" name="q2" value="a"> a) Temperature Inversion</label>
                        <label class="quiz-option"><input type="radio" name="q2" value="b"> b) Strong Dispersal Winds</label>
                        <label class="quiz-option"><input type="radio" name="q2" value="c"> c) Summer Heat Waves</label>
                    </div>
                    <div class="quiz-question">
                        <p>3. What is the primary health risk associated with high PM2.5 levels?</p>
                        <label class="quiz-option"><input type="radio" name="q3" value="a"> a) Respiratory & Lung Damage</label>
                        <label class="quiz-option"><input type="radio" name="q3" value="b"> b) Improved Visual Acuity</label>
                        <label class="quiz-option"><input type="radio" name="q3" value="c"> c) Increased Bone Density</label>
                    </div>
                    <button type="button" class="action-btn" onclick="submitQuiz()">Submit Answers</button>
                </form>
                <div id="quiz-feedback"></div>
            </div>
        </div>
    </section>

    <script>
        // Global variables
        let evMap = null;
        let evMarkers = [];
        let reportMap = null;
        let navMap = null;
        let routingControl = null;
        let userMarkerNav = null;
        let generatedCaptcha = "";
        let season = 'winter';
        let userCoords = [28.5355, 77.3910]; // Default Noida location to start
        
        // Live SOS Global vars
        let liveReportsMap = null;
        let liveReportsMarkers = [];
        let activeReports = [
            { id: 1, type: "Zero Visibility Smog", location: "Delhi-Meerut Expressway", lat: 28.6272, lng: 77.2798, time: "10 mins ago", severity: "High" },
            { id: 2, type: "Toxic Fire", location: "Okhla Phase 1", lat: 28.5273, lng: 77.2789, time: "25 mins ago", severity: "Critical" },
            { id: 3, type: "Major Accident", location: "Ring Road, Lajpat Nagar", lat: 28.5677, lng: 77.2433, time: "1 hour ago", severity: "High" }
        ];
        
        // AI Config
        const MISTRAL_KEY = "RAmK6mqLKrUnTv9YeEMFBnDQFcEFdafM"; 
        const MISTRAL_URL = "https://corsproxy.io/?https://api.mistral.ai/v1/chat/completions";

        function init() {
            getLocation();
            initCharts();
            initEvMap();
            generateCaptcha(); 
            initTimelineProgress();
            initVehicleChecker();
            renderLiveReports();
        }

        function switchTab(tabId) {
            const bannerHeight = document.getElementById('top-banner').offsetHeight;
            window.scrollTo({ top: bannerHeight, behavior: 'smooth' });
            
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            document.querySelectorAll('section').forEach(s => s.classList.remove('active-section'));
            document.getElementById('nav-' + tabId).classList.add('active');
            
            const targetSection = document.getElementById(tabId);
            targetSection.classList.add('active-section');

            if (tabId === 'ev' && evMap) {
                setTimeout(() => { evMap.invalidateSize(); }, 200);
            }
            if (tabId === 'navigation') {
                setTimeout(initNavMap, 200);
            }
            if (tabId === 'reports') {
                setTimeout(initLiveReportsMap, 200);
            }
        }

        // --- FETCH LIVE AQI & ACCURATE LIVE LOCATION & WEATHER ---
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    userCoords = [lat, lon];
                    document.getElementById('location-box').innerHTML = `<i class="fas fa-crosshairs"></i> ${lat.toFixed(4)}, ${lon.toFixed(4)} (Live GPS)`;
                    fetchLiveData(lat, lon); 
                    
                    // Update Map centers if already loaded
                    if (navMap) { navMap.setView(userCoords, 14); if (userMarkerNav) userMarkerNav.setLatLng(userCoords); }
                    if (reportMap) reportMap.setView(userCoords, 12);
                    if (liveReportsMap) liveReportsMap.setView(userCoords, 11);
                }, () => {
                    // Default to Noida Coordinates if denied
                    const noidaLat = 28.5355;
                    const noidaLon = 77.3910;
                    userCoords = [noidaLat, noidaLon];
                    document.getElementById('location-box').innerHTML = `<i class="fas fa-map-marker-alt"></i> Location Denied. Showing Noida Live Data.`;
                    fetchLiveData(noidaLat, noidaLon);
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                fetchLiveData(28.5355, 77.3910);
            }
        }

        async function fetchLiveData(lat, lon) {
            document.getElementById('aqi-text').innerText = "FETCHING LIVE DATA...";
            try {
                // Fetch AQI
                const aqiRes = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi`);
                const aqiData = await aqiRes.json();
                const aqi = aqiData.current.us_aqi;
                
                // Fetch Weather Data (Temp, Humidity, Wind)
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m`);
                const weatherData = await weatherRes.json();
                
                const temp = weatherData.current.temperature_2m;
                const humidity = weatherData.current.relative_humidity_2m;
                const windSpeed = weatherData.current.wind_speed_10m;
                
                let status = "SAFE";
                if(aqi > 450) status = "SEVERE+";
                else if(aqi > 400) status = "SEVERE";
                else if(aqi > 300) status = "VERY POOR";
                else if(aqi > 200) status = "POOR";
                else if(aqi > 100) status = "MODERATE";
                else if(aqi > 50) status = "SATISFACTORY";
                else status = "GOOD";

                // Update UI
                updateDashboard(aqi, status);
                
                document.getElementById('live-temp').innerText = `${temp} °C`;
                document.getElementById('live-humidity').innerText = `${humidity} %`;
                document.getElementById('live-wind').innerText = `${windSpeed} km/h`;
                
                const aqiColor = getAqiColor(aqi);
                const airQualEl = document.getElementById('live-air-qual');
                airQualEl.innerText = status;
                airQualEl.style.color = aqiColor;

            } catch (error) {
                console.error("Live Data Fetch Error:", error);
                updateDashboard(312, "VERY POOR (FALLBACK)");
                document.getElementById('live-temp').innerText = `22.5 °C`;
                document.getElementById('live-humidity').innerText = `48 %`;
                document.getElementById('live-wind').innerText = `8.2 km/h`;
                
                const airQualEl = document.getElementById('live-air-qual');
                airQualEl.innerText = "VERY POOR";
                airQualEl.style.color = getAqiColor(312);
            }
        }

        function getAqiColor(aqi) {
            if (aqi <= 50) return '#00ff9d'; // Good
            if (aqi <= 100) return '#a8ff00'; // Satisfactory
            if (aqi <= 200) return '#f1c40f'; // Moderate
            if (aqi <= 300) return '#ff9f43'; // Poor
            if (aqi <= 400) return '#ff003c'; // Very Poor
            return '#ff0000'; // Severe/Hazardous
        }

        function updateDashboard(aqi, status) {
            let current = 0;
            const aqiColor = getAqiColor(aqi);
            
            document.getElementById('aqi-text').innerText = status;
            document.getElementById('aqi-text').style.color = aqiColor;

            // Stop any existing animation
            if(window.aqiInterval) clearInterval(window.aqiInterval);

            window.aqiInterval = setInterval(() => {
                current += Math.ceil(aqi / 50) || 1;
                if(current >= aqi) {
                    current = aqi;
                    clearInterval(window.aqiInterval);
                }
                document.getElementById('main-aqi').innerText = current;
            }, 20);

            const circle = document.getElementById('aqi-progress-bar');
            const circumference = 2 * Math.PI * 140; 
            const maxAqi = 500; 
            const offset = circumference - (Math.min(aqi / maxAqi, 1) * circumference);
            
            circle.style.stroke = aqiColor;
            circle.style.filter = `drop-shadow(0 0 15px ${aqiColor})`;
            circle.style.strokeDashoffset = offset;

            // Automatically Update GRAP Protocols based on LIVE AQI
            updateGrapRules(aqi);
        }

        // --- AUTOMATICALLY UPDATE GRAP RESTRICTIONS BASED ON LIVE AQI ---
        function updateGrapRules(aqi) {
            let stage = "NORMAL";
            let fines = "None";
            let color = "#00ff9d";
            let vehText = "Air is safe. All compliant vehicles (except permanently banned overaged vehicles) are allowed.";
            let constText = "No restrictions on construction activities. Standard dust control rules apply.";
            let indText = "Industries may operate normally according to standard environmental guidelines.";

            if (aqi > 450) { 
                stage = "STAGE IV (SEVERE+)"; fines = "INR 20,000+ & FIR"; color = "#ff0000"; 
                vehText = "Complete ban on non-essential truck entry and Delhi-registered BS-IV diesel MGVs/LCVs. Strict ban on BS-III Petrol and BS-IV Diesel LMVs (4-wheelers).";
                constText = "Complete halt on ALL construction and demolition activities, including linear public projects (highways, roads, flyovers, pipelines).";
                indText = "Strict closure of non-essential industries. NCR offices ordered to operate at 50% capacity (Work From Home).";
            } else if (aqi > 400) { 
                stage = "STAGE III (SEVERE)"; fines = "INR 20,000+"; color = "#ff003c"; 
                vehText = "Restriction on plying of BS-III Petrol and BS-IV Diesel LMVs (4-wheelers) in Delhi-NCR.";
                constText = "Strict ban on non-essential construction and demolition activities. Includes boring, drilling, and excavation. Exemptions for Metro, Railway, Defense projects.";
                indText = "Industries not running on cleaner fuels (PNG) must close operations. Stone crushers and mining banned.";
            } else if (aqi > 300) { 
                stage = "STAGE II (VERY POOR)"; fines = "INR 10,000+"; color = "#ff9f43"; 
                vehText = "Targeted action against older highly polluting vehicles. Increased parking fees to discourage private transport.";
                constText = "Strict dust control at construction sites. Use of anti-smog guns and water sprinkling intensified.";
                indText = "Strict ban on use of diesel generator sets (except for emergency and essential services).";
            } else if (aqi > 200) { 
                stage = "STAGE I (POOR)"; fines = "Variable Fines"; color = "#f1c40f"; 
                vehText = "Strict enforcement of PUC (Pollution Under Control) norms. No direct bans on active BS-III/IV vehicles yet.";
                constText = "Enforcement of C&D waste management rules. Ban on open burning of waste and biomass.";
                indText = "Routine monitoring of industries. Night sweeping of roads mandated.";
            }

            document.getElementById('grap-stage-display').innerText = stage;
            document.getElementById('grap-stage-display').style.color = color;
            document.getElementById('grap-top-bar').style.borderColor = color;
            document.getElementById('grap-fine-display').innerText = fines;
            
            document.getElementById('grap-vehicle-text').innerHTML = `${vehText}<br><br><strong style="color:var(--neon-red)">Fine: ${fines} (Motor Vehicles Act)</strong>`;
            document.getElementById('grap-const-text').innerHTML = constText;
            document.getElementById('grap-ind-text').innerHTML = indText;
        }

        // --- ECO-SMART NAVIGATION LOGIC ---
        function initNavMap() {
            if (!navMap) {
                navMap = L.map('nav-map-container').setView(userCoords, 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors', maxZoom: 19 }).addTo(navMap);
                userMarkerNav = L.circleMarker(userCoords, { color: '#00d2ff', fillColor: '#00d2ff', fillOpacity: 0.8, radius: 10 }).addTo(navMap).bindPopup("Your Current Location").openPopup();
            } else {
                navMap.setView(userCoords, 14);
                navMap.invalidateSize();
                if(userMarkerNav) userMarkerNav.setLatLng(userCoords);
            }
        }

        async function calculateGreenRoute() {
            const dest = document.getElementById('nav-dest-input').value;
            if (!dest) return alert("Please enter a destination to navigate to.");

            const btn = document.getElementById('nav-route-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing Routes...';

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dest)}&countrycodes=in&limit=5`);
                const data = await response.json();
                
                if (data.length === 0) {
                    alert("Location not found. Try adding the city name (e.g., 'Hauz Khas, New Delhi').");
                    btn.innerHTML = '<i class="fas fa-location-arrow"></i> Find Cleanest Path';
                    return;
                }
                const destCoords = [data[0].lat, data[0].lon];

                if (routingControl) navMap.removeControl(routingControl);

                routingControl = L.Routing.control({
                    waypoints: [ L.latLng(userCoords[0], userCoords[1]), L.latLng(destCoords[0], destCoords[1]) ],
                    showAlternatives: true,
                    altLineOptions: { styles: [ {color: '#dc3545', opacity: 0.7, weight: 6, dashArray: '10, 10'} ] },
                    lineOptions: { styles: [ {color: '#28a745', opacity: 1, weight: 8} ] },
                    routeWhileDragging: false,
                    addWaypoints: false,
                    createMarker: function(i, wp, nWps) {
                        if (i === nWps - 1) { return L.marker(wp.latLng, { icon: L.divIcon({ html: '<i class="fas fa-map-marker-alt" style="color:#28a745; font-size:32px; text-shadow:2px 2px 5px rgba(0,0,0,0.5);"></i>', className: 'dest-marker', iconSize: [32,32], iconAnchor: [16,32] }) }); }
                        return null; 
                    }
                }).addTo(navMap);

                routingControl.on('routesfound', function(e) {
                    const routes = e.routes;
                    const fastRoute = routes[0]; 
                    const greenRoute = routes.length > 1 ? routes[1] : routes[0]; 

                    document.getElementById('route-stats').style.display = 'grid';
                    const gMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userCoords[0]},${userCoords[1]}&destination=${destCoords[0]},${destCoords[1]}`;

                    const currentAqi = parseInt(document.getElementById('main-aqi').innerText) || 210;
                    const greenAqi = Math.max(45, Math.floor(currentAqi * 0.6) - Math.floor(Math.random() * 10)); 
                    const fastAqi = currentAqi + Math.floor(Math.random() * 15);

                    document.getElementById('green-path-info').innerHTML = `
                        <i class="fas fa-wind"></i> <strong>Avg AQI: ${greenAqi} (Optimized)</strong><br>
                        <i class="fas fa-road"></i> ${(greenRoute.summary.totalDistance / 1000).toFixed(1)} km<br>
                        <i class="fas fa-clock"></i> Est. Time: ${Math.round(greenRoute.summary.totalTime / 60)} mins<br>
                        <i class="fas fa-shield-alt"></i> Maximum Exposure Reduction<br>
                        <button class="action-btn" onclick="window.open('${gMapsUrl}', '_blank')" style="margin-top: 15px; width: 100%; padding: 10px; border-color: #28a745; color: #28a745; background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
                            <i class="fas fa-external-link-alt"></i> Get Direction (Google Maps)
                        </button>
                    `;
                    
                    if(routes.length > 1) {
                        document.getElementById('fast-path-info').innerHTML = `
                            <i class="fas fa-smog"></i> <strong>Avg AQI: ${fastAqi} (High Exposure)</strong><br>
                            <i class="fas fa-road"></i> ${(fastRoute.summary.totalDistance / 1000).toFixed(1)} km<br>
                            <i class="fas fa-bolt"></i> Est. Time: ${Math.round(fastRoute.summary.totalTime / 60)} mins<br>
                            <i class="fas fa-exclamation-triangle"></i> Crosses Heavy Traffic Zones
                        `;
                    } else {
                        document.getElementById('fast-path-info').innerHTML = `
                            <i class="fas fa-info-circle"></i> Routing engine found only one viable path for this destination.
                        `;
                    }

                    btn.innerHTML = '<i class="fas fa-location-arrow"></i> Find Cleanest Path';
                    navMap.fitBounds(L.latLngBounds([userCoords, destCoords]), {padding: [50, 50]});
                });

                routingControl.on('routingerror', function() {
                    alert("Could not calculate a route between these points. Ensure they are connected by roads.");
                    btn.innerHTML = '<i class="fas fa-location-arrow"></i> Find Cleanest Path';
                });

            } catch (error) {
                alert("Network error while trying to fetch the route.");
                btn.innerHTML = '<i class="fas fa-location-arrow"></i> Find Cleanest Path';
                console.error(error);
            }
        }

        // --- CHART LOGIC ---
        function initCharts() {
            const ctx = document.getElementById('pollutantChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['PM 2.5', 'PM 10', 'NO2', 'CO'],
                    datasets: [{ data: [45, 30, 15, 10], backgroundColor: ['#ff0000', '#f1c40f', '#00d2ff', '#00ff9d'], borderColor: '#050505', borderWidth: 4, hoverOffset: 10 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { color: '#ccc', font: { family: 'Open Sans', size: 12 }, padding: 20, usePointStyle: true } }, tooltip: { backgroundColor: 'rgba(20, 20, 20, 0.9)', titleFont: { family: 'Montserrat' }, bodyFont: { family: 'Open Sans' }, padding: 12, borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1 } }, animation: { animateScale: true, animateRotate: true } }
            });

            const ctxCauses = document.getElementById('causesChart').getContext('2d');
            new Chart(ctxCauses, {
                type: 'bar',
                data: {
                    labels: ['Vehicular', 'Construction', 'Industrial', 'Farm Fires'],
                    datasets: [{ label: 'Impact (%)', data: [41, 21, 18, 15], backgroundColor: [ 'rgba(0, 210, 255, 0.8)', 'rgba(241, 196, 15, 0.8)', 'rgba(255, 159, 67, 0.8)', 'rgba(255, 0, 60, 0.8)' ], borderWidth: 0, borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#888', font: { family: 'Open Sans' } } }, x: { grid: { display: false }, ticks: { color: '#888', font: { family: 'Open Sans' } } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(20, 20, 20, 0.9)', titleFont: { family: 'Montserrat' }, bodyFont: { family: 'Open Sans' }, padding: 12, borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1 } } }
            });
        }

        function toggleGrap(element) {
            const content = element.querySelector('.grap-content');
            const icon = element.querySelector('.fa-chevron-down');
            if (content.style.display === "block") { content.style.display = "none"; icon.style.transform = "rotate(0deg)"; } 
            else { content.style.display = "block"; icon.style.transform = "rotate(180deg)"; }
        }

        /* --- EV MAP LOGIC --- */
        function initEvMap() {
            evMap = L.map('ev-map').setView([28.6139, 77.2090], 11);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles | Esri' }).addTo(evMap);

            const evIcon = L.divIcon({ className: 'custom-div-icon', html: "<div style='background-color:#00ff9d; width:20px; height:20px; border-radius:50%; box-shadow:0 0 10px #00ff9d; border: 2px solid white;'></div>", iconSize: [20, 20], iconAnchor: [10, 10] });

            const stations = [
                { lat: 28.5355, lng: 77.2694, name: "Tata Power Charging", address: "Okhla Industrial Estate Phase 2", state: "Delhi", status: "Available", power: "50 kW", connector: "CCS2" },
                { lat: 28.6983, lng: 77.1415, name: "BluSmart Hub", address: "Kohat Enclave Parking Area", state: "Delhi", status: "Available", power: "22 kW", connector: "Type 2" },
                { lat: 28.5715, lng: 77.2370, name: "Powerbank Charging", address: "Lajpat Nagar II, Central Market", state: "Delhi", status: "Available", power: "120 kW", connector: "CCS2 / CHAdeMO" },
                { lat: 28.6304, lng: 77.2177, name: "EESL Fast Hub", address: "Connaught Place, Middle Circle", state: "Delhi", status: "In Use (Wait: 15m)", power: "50 kW", connector: "CCS2" },
                { lat: 28.5700, lng: 77.3200, name: "Charge+Zone", address: "Sector 18 Commercial Market", state: "Uttar Pradesh", status: "Available", power: "60 kW", connector: "CCS2" },
                { lat: 28.6994, lng: 77.2041, name: "Reliance BP Mobility", address: "GTB Nagar Metro Parking", state: "Delhi", status: "Available", power: "150 kW", connector: "CCS2" },
                { lat: 28.6758, lng: 77.3124, name: "Sun Mobility", address: "Jhilmil Industrial Area Phase 1", state: "Delhi", status: "Maintenance Offline", power: "Battery Swap", connector: "N/A" },
                { lat: 28.6175, lng: 77.2792, name: "Powerbank Charging", address: "Pandav Nagar, NH-24", state: "Delhi", status: "Available", power: "22 kW", connector: "Type 2" },
                { lat: 28.4800, lng: 77.1255, name: "Shuchi Anant Virya", address: "Arjangarh Parking Hub", state: "Delhi", status: "Available", power: "50 kW", connector: "CCS2" },
                { lat: 28.4595, lng: 77.0266, name: "Ather Grid", address: "Galleria Market, Sector 28", state: "Haryana", status: "Available", power: "7.4 kW", connector: "Proprietary / Type 2" }
            ];

            let sidebarHTML = '';
            stations.forEach((st, index) => {
                let statusColor = st.status.includes('Available') ? '#008000' : (st.status.includes('Use') ? '#ff9f43' : '#ff003c');
                let statusClass = st.status.includes('Available') ? 'status-avail' : (st.status.includes('Use') ? 'status-busy' : 'status-down');
                let routeFuncCall = `window.open('https://www.google.com/maps/dir/?api=1&origin=${userCoords[0]},${userCoords[1]}&destination=${st.lat},${st.lng}', '_blank')`;

                let popupContent = `
                    <div style="font-family: 'Montserrat', sans-serif; color: #111; min-width: 220px;">
                        <h4 style="margin: 0 0 8px 0; font-weight: 800; font-size: 1.1rem; border-bottom: 2px solid #00d2ff; padding-bottom: 5px;">${st.name}</h4>
                        <p style="margin: 5px 0; font-family: 'Open Sans', sans-serif; font-size: 0.9rem;"><i class="fas fa-map-marker-alt" style="color:#ff003c; width:15px;"></i> <strong>Location:</strong> ${st.address}</p>
                        <p style="margin: 5px 0; font-family: 'Open Sans', sans-serif; font-size: 0.9rem;"><i class="fas fa-bolt" style="color:var(--neon-blue); width:15px;"></i> <strong>Power:</strong> ${st.power}</p>
                        <p style="margin: 5px 0; font-family: 'Open Sans', sans-serif; font-size: 0.9rem;"><i class="fas fa-plug" style="color:var(--neon-yellow); width:15px;"></i> <strong>Connector:</strong> ${st.connector}</p>
                        <div style="margin-top: 12px; margin-bottom: 12px; padding: 6px; background: rgba(0,0,0,0.05); border-radius: 5px; text-align: center; color: ${statusColor}; font-weight: 700; font-size: 0.9rem; border: 1px solid ${statusColor};">Status: ${st.status}</div>
                        <button onclick="${routeFuncCall}" style="width: 100%; background: #00d2ff; border: none; padding: 10px; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; transition: 0.3s;"><i class="fas fa-directions"></i> Get Direction</button>
                    </div>
                `;
                
                const marker = L.marker([st.lat, st.lng], { icon: evIcon }).addTo(evMap).bindPopup(popupContent);
                evMarkers.push(marker);

                sidebarHTML += `
                    <div class="ev-list-item" onclick="focusEvMarker(${index})">
                        <h5>${st.name}</h5>
                        <p style="margin-bottom: 8px;"><i class="fas fa-map-marker-alt"></i> ${st.address}</p>
                        <div style="display:flex; gap:8px; margin-bottom: 10px; flex-wrap: wrap;">
                            <span class="ev-badge ev-badge-power"><i class="fas fa-bolt"></i> ${st.power}</span>
                            <span class="ev-badge ev-badge-conn"><i class="fas fa-plug"></i> ${st.connector}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px;">
                            <span style="font-size:0.85rem;"><span class="ev-status-dot ${statusClass}"></span> ${st.status}</span>
                            <button onclick="event.stopPropagation(); ${routeFuncCall}" style="background: rgba(0,210,255,0.15); border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 5px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 5px;"><i class="fas fa-directions"></i> Route</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('ev-list').innerHTML = sidebarHTML;
        }

        function focusEvMarker(index) {
            const marker = evMarkers[index];
            if (marker) { evMap.flyTo(marker.getLatLng(), 15, { animate: true, duration: 1.5 }); setTimeout(() => { marker.openPopup(); }, 1500); }
        }

        // --- NEW LIVE REPORTS (SOS) MAP LOGIC ---
        function initLiveReportsMap() {
            if (!liveReportsMap) {
                liveReportsMap = L.map('live-reports-map').setView([28.6139, 77.2090], 11);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles | Esri' }).addTo(liveReportsMap);
            } else {
                liveReportsMap.invalidateSize();
            }
            drawLiveReportMarkers();
        }

        function drawLiveReportMarkers() {
            liveReportsMarkers.forEach(m => liveReportsMap.removeLayer(m));
            liveReportsMarkers = [];

            activeReports.forEach((report, index) => {
                let color = report.severity === 'Critical' ? '#ff003c' : '#ff9f43';
                const repIcon = L.divIcon({ className: 'custom-div-icon', html: `<div style='background-color:${color}; width:20px; height:20px; border-radius:50%; box-shadow:0 0 15px ${color}; border: 2px solid white;'></div>`, iconSize: [20, 20], iconAnchor: [10, 10] });
                
                let routeFuncCall = `window.open('https://www.google.com/maps/dir/?api=1&origin=${userCoords[0]},${userCoords[1]}&destination=${report.lat},${report.lng}', '_blank')`;

                let popupContent = `
                    <div style="font-family: 'Montserrat', sans-serif; color: #111; min-width: 200px;">
                        <h4 style="margin: 0 0 8px 0; font-weight: 800; font-size: 1.1rem; border-bottom: 2px solid ${color}; padding-bottom: 5px;">${report.type}</h4>
                        <p style="margin: 5px 0; font-family: 'Open Sans', sans-serif; font-size: 0.9rem;"><strong>Location:</strong> ${report.location}</p>
                        <p style="margin: 5px 0; font-family: 'Open Sans', sans-serif; font-size: 0.9rem;"><strong>Reported:</strong> ${report.time}</p>
                        <button onclick="${routeFuncCall}" style="width: 100%; margin-top: 10px; background: ${color}; border: none; padding: 10px; border-radius: 6px; color: #fff; font-weight: bold; cursor: pointer; transition: 0.3s;"><i class="fas fa-directions"></i> Get Direction</button>
                    </div>
                `;
                
                const marker = L.marker([report.lat, report.lng], { icon: repIcon }).addTo(liveReportsMap).bindPopup(popupContent);
                liveReportsMarkers.push(marker);
            });
        }

        function focusReportMarker(index) {
            const marker = liveReportsMarkers[index];
            if (marker) { liveReportsMap.flyTo(marker.getLatLng(), 15, { animate: true, duration: 1.5 }); setTimeout(() => { marker.openPopup(); }, 1500); }
        }

        function renderLiveReports() {
            let html = '';
            activeReports.forEach((report, index) => {
                let icon = report.type.includes('Fire') ? 'fa-fire' : (report.type.includes('Smog') ? 'fa-smog' : 'fa-car-crash');
                let color = report.severity === 'Critical' ? 'var(--danger-red)' : 'var(--neon-orange)';
                let routeCall = `window.open('https://www.google.com/maps/dir/?api=1&origin=${userCoords[0]},${userCoords[1]}&destination=${report.lat},${report.lng}', '_blank')`;
                
                html += `
                    <div class="ev-list-item" style="border-left: 4px solid ${color};" onclick="focusReportMarker(${index})">
                        <div style="display:flex; justify-content:space-between;">
                            <h5 style="color:${color}; margin: 0;"><i class="fas ${icon}"></i> ${report.type}</h5>
                            <span style="font-size: 0.75rem; color: #aaa;">${report.time}</span>
                        </div>
                        <p style="margin-bottom: 8px; margin-top: 8px;"><i class="fas fa-map-marker-alt"></i> ${report.location}</p>
                        <div style="display:flex; justify-content:space-between; align-items:center; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px;">
                            <span class="ev-badge" style="background: rgba(255,0,0,0.1); color: ${color}; border: 1px solid ${color};">${report.severity} Priority</span>
                            <button onclick="event.stopPropagation(); ${routeCall}" style="background: rgba(255,159,67,0.15); border: 1px solid var(--neon-orange); color: var(--neon-orange); padding: 5px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-hands-helping"></i> Help / Go There
                            </button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('live-reports-list').innerHTML = html;
        }

        // --- CHATBOT JS ---
        function toggleChatPanel() {
            const panel = document.getElementById('chatPanel');
            if (panel.style.display === 'block') { panel.style.display = 'none'; } else { panel.style.display = 'block'; document.getElementById('chatInput').focus(); }
        }

        function handleChatEnter(event) { if(event.key === 'Enter') sendChatMsg(); }

        async function sendChatMsg() {
            const input = document.getElementById('chatInput');
            const windowObj = document.getElementById('chatWindow');
            const msgText = input.value.trim();
            if(msgText === "") return;
            
            windowObj.innerHTML += `<div class="msg msg-user">${msgText}</div>`;
            input.value = "";
            windowObj.scrollTop = windowObj.scrollHeight;
            
            const typingId = "bot-typing-" + Date.now();
            windowObj.innerHTML += `<div class="msg msg-bot" id="${typingId}"><i class="fas fa-spinner fa-spin"></i> Analyzing atmosphere...</div>`;
            windowObj.scrollTop = windowObj.scrollHeight;

            try {
                const response = await fetch(MISTRAL_URL, {
                    method: "POST", headers: { "Authorization": `Bearer ${MISTRAL_KEY}`, "Content-Type": "application/json", "Accept": "application/json" },
                    body: JSON.stringify({
                        model: "mistral-small-latest",
                        messages: [
                            { role: "system", content: `You are Vayuxa, an expert AI guardian for Delhi's Air Quality. Your mission is to strictly answer questions related to pollution, AQI, EV vehicles, health precautions, GRAP, and climate change. Current Context: AQI 342. GRAP Stage III.` },
                            { role: "user", content: msgText }
                        ],
                        temperature: 0.3
                    })
                });
                const data = await response.json();
                if (response.ok) { document.getElementById(typingId).innerHTML = data.choices[0].message.content; } 
                else { document.getElementById(typingId).innerText = `Error: API limit or key invalid.`; }
            } catch (error) { document.getElementById(typingId).innerText = "Network Error. Connection intercepted."; }
            windowObj.scrollTop = windowObj.scrollHeight;
        }

        // --- REPORT MODAL LOGIC ---
        function openReportModal() {
            document.getElementById('report-modal').style.display = 'flex';
            if (!reportMap) setTimeout(initReportMap, 100); else setTimeout(() => reportMap.invalidateSize(), 100);
        }

        function closeReportModal() { document.getElementById('report-modal').style.display = 'none'; }

        function initReportMap() {
            reportMap = L.map('report-map').setView(userCoords, 12);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }).addTo(reportMap);
            reportMap.on('click', function(e) {
                reportMap.eachLayer(l => { if(l instanceof L.Marker) reportMap.removeLayer(l); });
                const redIcon = L.divIcon({ html: '<i class="fas fa-radiation-alt" style="color:#ff003c; font-size:30px; text-shadow:0 0 10px black;"></i>', className: 'marker', iconSize: [30, 30], iconAnchor: [15, 15] });
                L.marker(e.latlng, {icon: redIcon}).addTo(reportMap);
                document.getElementById('incident-loc-text').value = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
            });
        }

        function traceIncidentPath() {
            if(!reportMap) return;
            const center = reportMap.getCenter();
            L.polyline([userCoords, center], { color: '#ff003c', weight: 4, dashArray: '10, 10', opacity: 0.8 }).addTo(reportMap);
            reportMap.fitBounds(L.latLngBounds([userCoords, center]), {padding:[20,20]});
        }

        function generateCaptcha() {
            const chars = "ABCDEF1234567890"; let code = "";
            for(let i=0; i<4; i++) code += chars[Math.floor(Math.random()*chars.length)];
            generatedCaptcha = code; document.getElementById('captcha-display').innerText = code;
        }

        function submitReport(e) {
            e.preventDefault();
            if(document.getElementById('captcha-input').value.toUpperCase() !== generatedCaptcha) { alert("Incorrect Captcha!"); return; }
            
            // Get data from form to add to live feed
            const locText = document.getElementById('incident-loc-text').value;
            const type = document.getElementById('report-hazard-type').value;
            const fname = document.getElementById('report-fname').value;
            
            if(locText && type) {
                const parts = locText.split(',');
                const newReport = {
                    id: Date.now(),
                    type: type,
                    location: `Reported by ${fname} (Live GPS)`,
                    lat: parseFloat(parts[0]),
                    lng: parseFloat(parts[1]),
                    time: "Just now",
                    severity: type.includes('Fire') ? "Critical" : "High"
                };
                
                activeReports.unshift(newReport); // Add to beginning of array
                renderLiveReports();
                if(liveReportsMap) drawLiveReportMarkers();
            }
            
            alert("EMERGENCY REPORT TRANSMITTED & ADDED TO LIVE SOS FEED!");
            closeReportModal();
            document.getElementById('captcha-input').value = ""; // reset
        }

        // --- BALLOON LOGIC ---
        const pollutionFacts = [
            "Air pollution causes approximately 7 million premature deaths globally every year.",
            "Breathing Delhi's air in winter can be as harmful as smoking up to 25 cigarettes a day.",
            "PM2.5 particles are small enough to enter the bloodstream and damage vital organs.",
            "Over 90% of the world's population lives in areas where air quality exceeds WHO limits.",
            "Switching to EVs could reduce urban vehicular emissions by up to 70% in high-traffic zones."
        ];

        function handleBalloonPop() {
            const balloon = document.getElementById('balloonBtn');
            const popup = document.getElementById('factPopup');
            balloon.style.display = 'none';
            document.getElementById('factText').innerText = pollutionFacts[Math.floor(Math.random() * pollutionFacts.length)];
            popup.style.display = 'block';
            setTimeout(() => { closeFact(); balloon.style.display = 'flex'; }, 5000);
        }

        function closeFact() { document.getElementById('factPopup').style.display = 'none'; }
        
        // --- INSIGHTS/AWARENESS LOGIC ---
        function playSim(selectedSeason) {
            const vid = document.getElementById(selectedSeason + '-vid');
            const overlay = document.getElementById(selectedSeason + '-overlay');
            vid.style.filter = 'blur(0px)'; overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; vid.play(); }, 500); 
        }

        function setSeason(newSeason) {
            season = newSeason;
            const winterWrap = document.getElementById('winter-wrapper'); const summerWrap = document.getElementById('summer-wrapper');
            const btnWinter = document.getElementById('btn-winter'); const btnSummer = document.getElementById('btn-summer');
            
            if (season === 'winter') {
                if(winterWrap) winterWrap.style.display = 'block'; if(summerWrap) summerWrap.style.display = 'none';
                if(btnWinter) btnWinter.classList.add('active'); if(btnSummer) btnSummer.classList.remove('active');
                const summerVid = document.getElementById('summer-vid'); if (summerVid) summerVid.pause();
            } else {
                if(winterWrap) winterWrap.style.display = 'none'; if(summerWrap) summerWrap.style.display = 'block';
                if(btnWinter) btnWinter.classList.remove('active'); if(btnSummer) btnSummer.classList.add('active');
                const winterVid = document.getElementById('winter-vid'); if (winterVid) winterVid.pause();
            }
        }

        function submitQuiz() {
            const form = document.getElementById('quiz-form');
            if(!form.q1.value || !form.q2.value || !form.q3.value) { alert("Please answer all questions."); return; }
            let score = 0; let feedback = '';
            if (form.q1.value === 'a') score++; if (form.q2.value === 'a') score++; if (form.q3.value === 'a') score++;
            
            feedback += `<strong>Final Score: ${score}/3</strong><br><br>`;
            if (form.q1.value !== 'a') feedback += `<span style="color:var(--danger-red)">Q1: Incorrect.</span> Fact: Vehicles contribute 41% to Delhi's pollution.<br>`;
            if (form.q2.value !== 'a') feedback += `<span style="color:var(--danger-red)">Q2: Incorrect.</span> Fact: Temperature inversion traps pollutants.<br>`;
            if (form.q3.value !== 'a') feedback += `<span style="color:var(--danger-red)">Q3: Incorrect.</span> Fact: PM2.5 causes respiratory damage.<br>`;
            if(score === 3) feedback += "Perfect Score! You are highly aware of the environmental situation.";
            document.getElementById('quiz-feedback').innerHTML = feedback;
        }

        function initTimelineProgress() {
            const timeline = document.querySelector('.timeline'); const progressBar = document.querySelector('.progress-bar');
            if (timeline && progressBar) {
                timeline.addEventListener('scroll', () => {
                    const progress = (timeline.scrollLeft / (timeline.scrollWidth - timeline.clientWidth)) * 100;
                    progressBar.style.width = `${progress}%`;
                });
            }
        }

        // --- COMPREHENSIVE GRAP VEHICLE STATUS CHECKER LOGIC RESTORED ---
        const defaultYears = [2008, 2010, 2012, 2015, 2018, 2020, 2022, 2024];
        const defaultFuel = ["Petrol", "Diesel"];
        const evFuel = ["Petrol", "Diesel", "Electric", "CNG"];

        const vehicleDatabase = {
            "Ford": { "EcoSport": { years: defaultYears, fuel: defaultFuel }, "Endeavour": { years: defaultYears, fuel: ["Diesel"] } },
            "Honda": { "City": { years: defaultYears, fuel: defaultFuel }, "Amaze": { years: defaultYears, fuel: defaultFuel } },
            "Hyundai": { "Creta": { years: defaultYears, fuel: defaultFuel }, "i20": { years: defaultYears, fuel: defaultFuel }, "Ioniq 5": { years: [2022, 2024], fuel: ["Electric"] } },
            "Jeep": { "Compass": { years: [2017, 2019, 2021, 2023], fuel: defaultFuel } },
            "Kia": { "Seltos": { years: [2019, 2021, 2023], fuel: defaultFuel }, "EV6": { years: [2022, 2023], fuel: ["Electric"] } },
            "MG Motors": { "Hector": { years: [2019, 2021, 2023], fuel: defaultFuel }, "ZSEV": { years: [2020, 2022, 2023], fuel: ["Electric"] } },
            "Mahindra": { "Thar": { years: defaultYears, fuel: defaultFuel }, "XUV700": { years: [2021, 2023], fuel: defaultFuel } },
            "Maruti Suzuki": { "Swift": { years: defaultYears, fuel: ["Petrol", "Diesel", "CNG"] }, "Baleno": { years: defaultYears, fuel: ["Petrol", "CNG"] } },
            "Nissan": { "Magnite": { years: [2020, 2022, 2024], fuel: ["Petrol"] }, "Kicks": { years: [2019, 2021], fuel: defaultFuel } },
            "Renault": { "Kwid": { years: [2015, 2018, 2021], fuel: ["Petrol"] }, "Duster": { years: [2012, 2016, 2020], fuel: defaultFuel } },
            "Skoda": { "Slavia": { years: [2022, 2024], fuel: ["Petrol"] }, "Octavia": { years: defaultYears, fuel: defaultFuel } },
            "Tata Motors": { "Nexon": { years: [2017, 2019, 2021, 2023], fuel: evFuel }, "Punch": { years: [2021, 2023], fuel: ["Petrol", "Electric", "CNG"] } },
            "Toyota": { "Innova": { years: defaultYears, fuel: defaultFuel }, "Fortuner": { years: defaultYears, fuel: defaultFuel } },
            "Volkswagen": { "Polo": { years: defaultYears, fuel: defaultFuel }, "Taigun": { years: [2021, 2023], fuel: ["Petrol"] } }
        };

        function initVehicleChecker() {
            const manuSelect = document.getElementById("grap-manufacturer");
            const sortedBrands = Object.keys(vehicleDatabase).sort();
            for (const brand of sortedBrands) manuSelect.add(new Option(brand, brand));
        }

        function updateModels() {
            const manu = document.getElementById("grap-manufacturer").value;
            const modelSelect = document.getElementById("grap-model");
            modelSelect.innerHTML = '<option value="">Select model...</option>';
            document.getElementById("grap-year").disabled = true; document.getElementById("grap-fuel").disabled = true;
            if (manu) {
                for (const model of Object.keys(vehicleDatabase[manu]).sort()) modelSelect.add(new Option(model, model));
                modelSelect.disabled = false; modelSelect.style.opacity = 1;
            }
        }

        function updateYears() {
            const manu = document.getElementById("grap-manufacturer").value;
            const model = document.getElementById("grap-model").value;
            const yearSelect = document.getElementById("grap-year");
            yearSelect.innerHTML = '<option value="">Select year...</option>';
            if (model) {
                vehicleDatabase[manu][model].years.sort((a,b)=>b-a).forEach(y => yearSelect.add(new Option(y, y)));
                yearSelect.disabled = false; yearSelect.style.opacity = 1;
            }
        }

        function updateFuel() {
            const manu = document.getElementById("grap-manufacturer").value;
            const model = document.getElementById("grap-model").value;
            const fuelSelect = document.getElementById("grap-fuel");
            fuelSelect.innerHTML = '<option value="">Select fuel type...</option>';
            if (model) {
                vehicleDatabase[manu][model].fuel.sort().forEach(f => fuelSelect.add(new Option(f, f)));
                fuelSelect.disabled = false; fuelSelect.style.opacity = 1;
            }
        }

        function checkVehicleStatus() {
            const fuel = document.getElementById("grap-fuel").value;
            const year = parseInt(document.getElementById("grap-year").value);
            const resultBox = document.getElementById("grap-result-box");
            
            const showResult = (msg, col, bg) => { resultBox.style.display = "block"; resultBox.style.borderLeft = `4px solid ${col}`; resultBox.style.backgroundColor = bg; resultBox.style.color = "#fff"; resultBox.innerHTML = msg; };

            if (!fuel || !year) return showResult("<strong><i class='fas fa-exclamation-triangle'></i> ERROR:</strong> Please complete all dropdowns.", "var(--danger-red)", "rgba(255, 0, 60, 0.1)");
            
            const age = 2026 - year; // Currently 2026 context
            const currentAqi = parseInt(document.getElementById('main-aqi').innerText) || 0;
            const isStage3or4 = currentAqi >= 400; // GRAP Stage III trigger
            
            if (fuel === "Electric" || fuel === "CNG" || fuel === "Hybrid") showResult(`✅ <strong style="color:var(--neon-green)">STATUS: ALLOWED.</strong><br><br>Clean fuel vehicles are exempt from GRAP restrictions at all stages.`, "var(--neon-green)", "rgba(0, 255, 157, 0.1)");
            else if (fuel === "Diesel") {
                if (age >= 10) showResult(`⛔ <strong style="color:var(--danger-red)">STATUS: BANNED.</strong><br><br>Diesel vehicles 10 years or older are permanently banned in Delhi-NCR, regardless of GRAP stage.`, "var(--danger-red)", "rgba(255, 0, 60, 0.1)");
                else if (year < 2020 && isStage3or4) showResult(`❌ <strong style="color:var(--neon-yellow)">STATUS: RESTRICTED.</strong><br><br>BS-IV Diesel vehicles are banned under the current GRAP Stage (Live AQI > 400). Fine: INR 20,000.`, "var(--neon-yellow)", "rgba(241, 196, 15, 0.1)");
                else if (year < 2020 && !isStage3or4) showResult(`⚠️ <strong style="color:var(--neon-yellow)">STATUS: ALLOWED (CURRENTLY).</strong><br><br>BS-IV Diesel is permitted under the current AQI, but will be restricted immediately if AQI crosses 400 (Stage III).`, "var(--neon-yellow)", "rgba(241, 196, 15, 0.1)");
                else showResult(`✅ <strong style="color:var(--neon-green)">STATUS: ALLOWED.</strong><br><br>BS-VI Diesel vehicles are permitted.`, "var(--neon-green)", "rgba(0, 255, 157, 0.1)");
            } 
            else if (fuel === "Petrol") {
                if (age >= 15) showResult(`⛔ <strong style="color:var(--danger-red)">STATUS: BANNED.</strong><br><br>Petrol vehicles 15 years or older are permanently banned in Delhi-NCR, regardless of GRAP stage.`, "var(--danger-red)", "rgba(255, 0, 60, 0.1)");
                else if (year < 2010 && isStage3or4) showResult(`❌ <strong style="color:var(--neon-yellow)">STATUS: RESTRICTED.</strong><br><br>BS-III Petrol vehicles are banned under the current GRAP Stage (Live AQI > 400). Fine: INR 20,000.`, "var(--neon-yellow)", "rgba(241, 196, 15, 0.1)");
                else if (year < 2010 && !isStage3or4) showResult(`⚠️ <strong style="color:var(--neon-yellow)">STATUS: ALLOWED (CURRENTLY).</strong><br><br>BS-III Petrol is permitted under the current AQI, but will be restricted immediately if AQI crosses 400 (Stage III).`, "var(--neon-yellow)", "rgba(241, 196, 15, 0.1)");
                else showResult(`✅ <strong style="color:var(--neon-green)">STATUS: ALLOWED.</strong><br><br>BS-IV/BS-VI Petrol vehicles are permitted.`, "var(--neon-green)", "rgba(0, 255, 157, 0.1)");
            }
        }

        window.onload = init;
    </script>
</body>
</html>
